# Обновления интеграции с `/v1/analyze/json`

## Подготовка текста перед отправкой
* Текст снимка очищается от управляющих символов, лишних пробелов и последовательностей переводов строки, чтобы внешний сервис всегда получал валидный `text_par`. Пустой результат считается ошибкой и останавливает обработку конкретного ИНН.
* Логируем длину исходного и нормализованного текста, а также метаданные снимка для диагностики проблемных случаев.

## Формирование каталожных данных
* Вспомогатель `\_prepare_catalog_payload` конвертирует строки каталога в контрактный формат `CatalogItemsPayload` с ключом `items`. Для каждого элемента сохраняются `id`, `name` и структура `vec`.
* `vec` строится функцией `\_build_catalog_vector_payload`, которая возвращает и числовые значения (`values`), и строковое представление (`literal`). Это гарантирует совместимость с downstream-сервисом, который может использовать любой вариант.

## Очистка и логирование запросов/ответов
* Перед логированием тяжёлые поля (каталоги, длинные тексты) заменяются краткими сводками, чтобы журналы не содержали PII и огромные структуры.
* Для каждого запуска сохраняем очищенные запросы и ответы, а также отдельный блок `external_response_raw` с непреобразованным JSON от сервиса анализа. Это позволяет увидеть оригинальный `answer_raw` и другие поля LLM без необходимости повторного вызова.
* Если внешний сервис отвечает ошибкой для отдельного домена, запуск помечается как неуспешный, но остальная обработка продолжается. В итоговом ответе `status` может принимать значение `partial`, если часть доменов обработана успешно, либо `error`, если все попытки завершились неудачей.

## Запись каталожных ответов
* При применении `db_payload` теперь учитывается поле `text` из элементов `MatchedItemPayload`, поэтому товары и оборудование записываются даже если внешний сервис не заполнил `name`.
* В сжатых представлениях (`runs[].external_response`, `external_response`) поле `text` сохраняется вместе с `name`, чтобы сравнить исходный ответ модели и нормализованное значение.

## Поведение при пустом `company_id`
* `company_id` теперь передаётся только если он присутствует в снимке. Это соответствует схеме запроса и избавляет внешний сервис от `null` значений в верхнем уровне.

