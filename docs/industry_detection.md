# Определение отрасли в `ai_analyzer`

Документ описывает текущую схему поиска отрасли компании по результатам
парсинга сайтов. Алгоритм реализован в `app/services/ai_analyzer.py` и
используется при формировании ответа `AnalyzeCompanyResponse`.

## 1. Источники данных
1. Таблица `ai_site_prodclass` хранит списки продклассов с сайта и их оценки.
2. Для каждого продкласса подгружается запись из справочника (`ib_prodclass`,
   `prodclass` или `product_class`).
3. Дополнительно загружается справочник отраслей (`ib_industry`, `industry`,
   `industries`), чтобы сопоставить `industry_id` с читабельным названием.
4. Если отрасль по сайту не найдена, используется ИНН и код ОКВЭД из DaData как
   резервный источник.

## 2. Обогащение справочника продклассов
1. `_load_lookup_table` загружает все возможные текстовые колонки для
   продклассов и отраслей.
2. `_enrich_prodclass_lookup_with_industry` ищет `industry_id` в записях
   продклассов, подтягивает соответствующую строку из справочника отраслей и
   дописывает читабельное название и код отрасли прямо в запись продкласса.
3. В обогащённой записи гарантированно присутствуют `industry_label` и
   `industry_id`, если такие данные есть в базе.

## 3. Построение итогового значения
1. `_resolve_industry_from_prodclass` перебирает найденные продклассы в порядке
   убывания `prodclass_score`.
2. Для каждого продкласса берётся `industry_label` (подготовленный на шаге 2) и
   форматируется вместе с `industry_id` через `_format_with_id`.
3. Если ни один продкласс не дал отрасль, сервис запоминает лучшее
   человекочитаемое название продкласса и возвращает его в качестве запаса.
4. Когда по сайту ничего не найдено, `_okved_to_industry` конвертирует код
   ОКВЭД (из карточки клиента или DaData) в укрупнённую отрасль.

## 4. Обработка нетипичных данных
1. `_maybe_parse_json` позволяет корректно разобрать значения колонок, где
   отрасль хранится в JSON-формате (например, `{"id": 3, "name": "Химия"}`).
2. `_extract_industry_id` и `_extract_industry_label` проходят по вложенным
   структурам и спискам, поэтому даже массив объектов или строка с JSON не
   приводят к потере информации.
3. Для числовых значений применяется `_safe_int`, что защищает от ситуаций, где
   ID отрасли сохранён как строка.

Этот алгоритм делает определение отрасли максимально устойчивым к различным
вариациям данных и позволяет использовать единую логику как для «чистых»
справочников, так и для результатов, сохранённых после работы LLM.
